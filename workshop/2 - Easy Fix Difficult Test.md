# Easy Fix, Difficult Test

## Here is the sample app

### What does it do?

We own a company that sells Books on-line in various cities around the world. 
To manage our purchases, we have developed an internal system that has two 
portals:

#### 1. Customer Portal

This portal, provides our customers with features allowing them to search for 
and purchase books. 

The purchase workflow is as follows: 
1. Customers add the books they want to purchase to a basket.     
1. They then checkout their basket.
1. Upon checkout, our system should generate an invoice. The invoice should 
have the following properties: 
    1. Tax rates and tax reduction rules should be applied for each item in 
    the basket 
    2. The total amount of the invoice should be the sum of the amount of all 
    books (after tax) in the basket
    3. The currency of the invoice is the same currency as the respective 
    country
1. The Invoice is sent to the customer and a copy of it is saved in our 
repository for future reference   

> It is important to note that each country has its own tax rates and tax 
reduction rules. You can find a table of those rules below.  
 
#### 2. Reporting Portal

The second portal is used by administrators to generate reports of the sales 
around the world. 

The report should include the following: 
1. Accumulative sum of all the issued invoices
1. The currency of the report should be in USD 

### Countries, Currencies, Language, Tax Rates, and Tax Reduction Rules   

| Country       | Currency          | Language  | Exchange Rate to USD  | Tax Rate | Tax Reduction Rules                              | 
| :-------------|:-----------------:| :--------:| :--------------------:|:--------:|:------------------------------------------------:|
| USA           | USD               | English   | 1.0                   | 15%      | Reduction by 2% on Novels                        |  
| France        | Euro              | French    | 1.14                  | 25%      | No Reduction on taxes                            | 
| UK            | Pound Sterling    | English   | 1.27                  | 20%      | Reduction by 7% on Novels                        |
| Spain         | Euro              | Spanish   | 1.14                  | 10%      | Removed taxes on all foreign language books      |  
| China         | Renminbi          | Mandarin  | 0.15                  | 35%      | Removed taxes on all foreign language books      |
| Japan         | YEN               | Japanese  | 0.0093                | 30%      | No Reduction on taxes                            |
| Australia     | Australian Dollar | English   | 0.70                  | 13%      | No Reduction on taxes                            |     
| Germany       | Euro              | German    | 1.14                  | 22%      | Dropped to 5% on books written by German Authors |  


### Repository

The repository is our database where we store copies of all the issued invoices. 
The repository is defined by an interface that has 2 methods: 
1. addInvoice: adds an invoice to the repository's database 
1. getInvoiceMap: return all the available invoices in a Map  

Having this interface enables us to have different implementations for our 
database (Json, InMemory, Relational, NoSql, etc). 

In this workshop, we wrote a JSON implementation for this Repository interface
([JsonRepository.java](./src/main/java/com/murex/tbw/storage/JsonRepository.java)). 
We assumed that we are storing our data in JSON format in a [file](./src/main/resources/repository.json) 
under the resources folder.  

On initialization, the class parses the Json file and loads the data into a Map.

The MainRepository singleton returns the currently configured Repository.


## With a bug!

We noticed that some of the numbers generated by the report are wrong. 

| Country                                 | Actual | Expected | 
|:---------------------------------------:|:------:|:--------:| 
| The total number of books sold          | 16     |    16    |
| The total number of issued invoices     | 6      |    6     |
| The total amount of all invoices in USD | 1016.04|          |

Fortunately, our great team mates gave us some clues as to the origin of the
problem:

> It looks like conversion rates and tax reductions were not applied.
> [The domain expert]

> It's weird because there is code for these in TaxRule and CurrencyConverter!
> [A senior developer]

## Your mission is to fix it and unit test it

### 1. Explore and test a fix

Let's start by exploring the problem.

Under the resources folder, you can find a JSON file ([repository.json](./src/main/resources/repository.json)) 
that contains the data of issued invoices from previous transactions.

> Note that the total amount of each invoice is not included in this list. 

Our Main class ([Application.java](./src/main/java/Application.java)) does the
following: 
1. Reads the JSON file
1. Rebuilds the invoices in our current Repository instance 
1. Initializes a ReportGenerator
1. Prints 3 values:
    1. Total number of books sold
    2. Total number of issued invoices
    3. Sum of total amount of all invoices

### 2. Now revert

You should have found 2 bugs, one in Invoice, and another one in 
ReportGenerator. Now that we know what caused the issue, let's try to do the
fix correctly. We'd like to add a unit test to reproduce the issue first.

So let's revert!

### 3. Write a test on Invoice and only then fix it

Let's add the test to Invoice, reproduce the issue, and fix the code. 

### 4. [BONUS] Write a test on ReportGenerator and only then fix it

If you have the time, do the same for ReportGenerator: add a test, reproduce
and fix.

## Mini Retro

Take a few minutes to discuss the goods and the bads of this approach.